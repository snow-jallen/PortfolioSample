@page "/"
@inject Portfolio.BlazorWasm.ProjectApiService projectApi
@inject HttpClient http
@using Microsoft.Extensions.Configuration
@using Portfolio.Shared.ViewModels
@inject IConfiguration config
@using Polly;

@using Portfolio.Shared

<h1>Portfolio Sample</h1>

<div>Base Address: @http.BaseAddress</div>
<div>Config: @config["ConfigValue"]</div>

<h3>Add a project</h3>
<div class="form-field">
    <input placeholder="project name" @bind-value="newProjectName">
</div>
<div class="form-field">
    <button @onclick="addProject">Add Project</button>
</div>
<hr/>
<button @onclick="GetProjects">Load Project List</button>
<h3>List of Projects</h3>
<ul>
    @foreach(var p in projects)
    {
        <li><a href="project/@p.Title.ToSlug()">@p.Title</a><br/></li>
    }
</ul>

@code {
    private string newProjectName;
    private IEnumerable<ProjectViewModel> projects = new List<ProjectViewModel>();

    private async Task addProject()
    {
        var project = new Portfolio.Shared.Project{
            Title = newProjectName,
        };
        await projectApi.SaveProjectAsync(project);
    }

    private async Task GetProjects()
    {
        await Polly.Policy
            .Handle<TimeoutException>()
            .WaitAndRetryForever(retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)))
            .Execute(async ()=>
            {
                System.Diagnostics.Debug.WriteLine("Trying to make the call again...");
                projects = await projectApi.GetProjectsAsync();
            });
    }

    protected override async Task  OnInitializedAsync()
    {
        await GetProjects();
    }
}